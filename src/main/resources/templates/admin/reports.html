<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Báo cáo thống kê</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
</head>

<body class="d-flex flex-column min-vh-100">
    <th:block th:replace="~{layout::header}"></th:block>

    <div class="container flex-grow-1 pt-4">
        <h2 class="page-title mb-4">Trung tâm Báo cáo (Dynamic Report)</h2>

        <form method="post" action="/admin/reports/export" class="card-custom p-4 bg-white shadow-sm rounded">
            <div class="row">
                <!-- 1. LEFT: REPORT TYPE -->
                <div class="col-md-3 border-end">
                    <h5 class="mb-3 text-secondary">Loại báo cáo</h5>
                    <div class="list-group mb-3">
                        <label class="list-group-item list-group-item-action active" style="cursor: pointer;">
                            <input class="form-check-input me-2" type="radio" name="reportType" value="BOOK_SALES"
                                checked>
                            <i class="fas fa-book me-2"></i>Sách bán chạy
                        </label>
                        <label class="list-group-item list-group-item-action" style="cursor: pointer;">
                            <input class="form-check-input me-2" type="radio" name="reportType" value="USER_SPENDING">
                            <i class="fas fa-users me-2"></i>User Chi tiêu (VIP)
                        </label>
                        <label class="list-group-item list-group-item-action" style="cursor: pointer;">
                            <input class="form-check-input me-2" type="radio" name="reportType"
                                value="REVENUE_PLATFORM">
                            <i class="fas fa-chart-pie me-2"></i>Thống kê Nền tảng
                        </label>
                    </div>
                </div>

                <!-- 2. RIGHT: CONFIGURATION -->
                <div class="col-md-9 ps-md-4">
                    <h5 class="mb-3 text-secondary">Cấu hình xuất dữ liệu</h5>

                    <!-- Filters Row -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">Giới hạn (Limit)</label>
                            <select name="limit" class="form-select shadow-sm">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="50">Top 50</option>
                                <option value="1000">Tất cả (Max 1000)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">Tiêu chí Sắp xếp</label>
                            <select name="sortBy" id="sortBySelect" class="form-select shadow-sm">
                                <!-- Options will be updated by JS -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted">Thứ tự</label>
                            <select name="sortDirection" class="form-select shadow-sm">
                                <option value="DESC" selected>Giảm dần (Cao -> Thấp)</option>
                                <option value="ASC">Tăng dần (Thấp -> Cao)</option>
                            </select>
                        </div>
                    </div>

                    <hr class="text-muted opacity-25">

                    <!-- Columns Checkbox Container -->
                    <h6 class="mb-3 fw-bold small text-muted">Chọn cột dữ liệu hiển thị trong Excel:</h6>
                    <div class="p-3 bg-light rounded border">

                        <!-- 1. BOOK COLUMNS -->
                        <div id="cols-BOOK_SALES" class="cols-group d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked disabled data-locked="true">
                                ID Sách
                                <input type="hidden" name="selectedColumns" value="id">
                            </div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="title" checked> Tên Sách</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="category" checked> Thể loại</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="author"> Tác giả</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="price" checked> Giá bán</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="sold" checked> <span class="text-success fw-bold">Số
                                    lượng bán</span></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="revenue"> <span class="text-danger fw-bold">Doanh
                                    thu</span></div>
                        </div>

                        <!-- 2. USER COLUMNS -->
                        <div id="cols-USER_SPENDING" class="cols-group d-flex flex-wrap gap-3 d-none">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" checked disabled data-locked="true">
                                ID User
                                <input type="hidden" name="selectedColumns" value="id">
                            </div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="username" checked> Username</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="fullname" checked> Họ Tên</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="email" checked> Email</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="provider"> Nền tảng</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="total_spent" checked> <span
                                    class="text-danger fw-bold">Tổng Chi Tiêu</span></div>
                        </div>

                        <!-- 3. PLATFORM COLUMNS -->
                        <div id="cols-REVENUE_PLATFORM" class="cols-group d-flex flex-wrap gap-3 d-none">
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="platform" checked disabled> Nền tảng</div>
                            <div class="form-check"><input class="form-check-input" type="checkbox"
                                    name="selectedColumns" value="count" checked disabled> Số lượng User</div>
                        </div>

                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill shadow fw-bold mt-4">
                        <i class="fas fa-file-excel me-2"></i>XUẤT BÁO CÁO NGAY
                    </button>
                    <div class="text-center mt-2 small text-muted">
                        File Excel (.xlsx) sẽ được tải về tự động.
                    </div>
                </div>
            </div>
        </form>
    </div>

    <th:block th:replace="~{layout::footer}"></th:block>

    <!-- SCRIPT TO HANDLE DYNAMIC UI (After Footer loaded jQuery) -->
    <script>
        $(document).ready(function () {
            // Mapping for Sort Options
            const sortOptions = {
                'BOOK_SALES': [
                    { val: 'quantity', text: 'Số lượng bán ra' },
                    { val: 'revenue', text: 'Doanh thu ước tính' },
                    { val: 'price', text: 'Giá niêm yết' }
                ],
                'USER_SPENDING': [
                    { val: 'total_spent', text: 'Tổng chi tiêu' },
                    { val: 'name', text: 'Tên đăng nhập' }
                ],
                'REVENUE_PLATFORM': [
                    { val: 'count', text: 'Số lượng User' }
                ]
            };

            // Toggle active state for list group items
            $('input[name="reportType"]').change(function () {
                var type = $(this).val();

                // UI Active Class
                $('.list-group-item').removeClass('active');
                $(this).closest('label').addClass('active');

                // 1. Toggle Columns Area
                $('.cols-group').addClass('d-none');

                // Disable hidden inputs so they are not submitted
                $('.cols-group input').prop('disabled', true);

                var activeGroup = $('#cols-' + type);
                activeGroup.removeClass('d-none');

                // Re-enable inputs in the active group
                activeGroup.find('input').each(function () {
                    if ($(this).attr('data-locked') === 'true') return;
                    $(this).prop('disabled', false);
                });

                // 2. Update Sort Options
                var options = sortOptions[type];
                var select = $('#sortBySelect');
                select.empty();
                if (options) {
                    options.forEach(function (opt) {
                        select.append(new Option(opt.text, opt.val));
                    });
                }
            });

            // Trigger on load
            $('input[name="reportType"]:checked').trigger('change');
        });
    </script>
</body>

</html>