<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
</head>

<body class="d-flex flex-column min-vh-100">
    <th:block th:replace="~{layout::header}"></th:block>

    <div class="container flex-grow-1 pt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card-custom p-4 mb-4">
                    <h3 class="mb-4 text-primary"><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng</h3>
                    <form th:action="@{/cart/submit}" method="post" id="checkout-form">

                        <!-- Option Selection for Logged-in User -->
                        <div th:if="${user != null}" class="mb-4">
                            <!-- Option 1: Use Default Profile -->
                            <div class="form-check mb-3 p-3 border rounded bg-light position-relative"
                                th:if="${user.phone != null and user.address != null and !#strings.isEmpty(user.phone) and !#strings.isEmpty(user.address)}">
                                <input class="form-check-input position-absolute top-50 start-0 translate-middle-y ms-3"
                                    type="radio" name="addressOption" id="optDefault" value="default" checked
                                    onchange="fillAddress(true)">
                                <label class="form-check-label w-100 ps-4" for="optDefault" style="cursor: pointer;">
                                    <span class="fw-bold text-primary"><i class="fas fa-user-check me-2"></i>Thông tin
                                        từ hồ sơ</span>
                                    <div class="ms-1 mt-1 small text-muted border-start border-3 border-primary ps-2">
                                        <div th:text="${user.fullName}">Ten</div>
                                        <div th:text="${user.phone}">SĐT</div>
                                        <div th:text="${user.address}">Dia chi</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Option 2: Enter New Address -->
                            <div class="form-check p-3 border rounded position-relative">
                                <input class="form-check-input position-absolute top-50 start-0 translate-middle-y ms-3"
                                    type="radio" name="addressOption" id="optNew" value="new"
                                    th:checked="${user.phone == null or user.address == null or #strings.isEmpty(user.phone) or #strings.isEmpty(user.address)}"
                                    onchange="fillAddress(false)">
                                <label class="form-check-label w-100 ps-4 fw-bold" for="optNew"
                                    style="cursor: pointer;">
                                    <i class="fas fa-pen me-2"></i>Nhập địa chỉ nhận hàng mới
                                </label>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div id="shipping-info-fields" class="mt-3">
                            <div class="mb-3">
                                <label class="form-label" for="receiverName">Tên người nhận <span
                                        class="text-danger">*</span></label>
                                <input class="form-control" type="text" id="receiverName" name="receiverName" required
                                    th:value="${user != null && user.fullName != null ? user.fullName : ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="phoneNumber">Số điện thoại <span
                                        class="text-danger">*</span></label>
                                <input class="form-control" type="text" id="phoneNumber" name="phoneNumber" required
                                    th:value="${user != null && user.phone != null ? user.phone : ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="address">Địa chỉ chi tiết <span
                                        class="text-danger">*</span></label>
                                <textarea class="form-control" id="address" name="address" rows="3" required
                                    th:text="${user != null && user.address != null ? user.address : ''}"></textarea>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="note">Ghi chú giao hàng:</label>
                            <textarea class="form-control" id="note" name="note" rows="2"
                                placeholder="Ví dụ: Gọi trước khi giao, để ở quầy lễ tân..."></textarea>
                        </div>

                        <!-- Payment Method Section -->
                        <div class="mt-4">
                            <h4 class="mb-3 text-primary"><i class="fas fa-credit-card me-2"></i>Phương thức thanh toán
                            </h4>
                            <div class="d-grid gap-2">
                                <div class="form-check p-3 border rounded bg-white shadow-sm position-relative">
                                    <input
                                        class="form-check-input position-absolute top-50 start-0 translate-middle-y ms-3"
                                        type="radio" name="paymentMethod" id="paymentCOD" value="COD" checked>
                                    <label class="form-check-label w-100 ps-5" for="paymentCOD"
                                        style="cursor: pointer;">
                                        <div class="fw-bold fs-5 text-dark"><i
                                                class="fas fa-money-bill-wave me-2 text-success"></i>Thanh toán khi nhận
                                            hàng (COD)</div>
                                        <div class="small text-muted">Thanh toán tiền mặt cho shipper khi nhận được
                                            hàng.</div>
                                    </label>
                                </div>

                                <div class="form-check p-3 border rounded bg-white shadow-sm position-relative">
                                    <input
                                        class="form-check-input position-absolute top-50 start-0 translate-middle-y ms-3"
                                        type="radio" name="paymentMethod" id="paymentVNPAY" value="VNPAY">
                                    <label class="form-check-label w-100 ps-5" for="paymentVNPAY"
                                        style="cursor: pointer;">
                                        <div class="fw-bold fs-5 text-primary"><i class="fas fa-qrcode me-2"></i>Thanh
                                            toán qua VNPAY</div>
                                        <div class="small text-muted">Quét mã QR qua ứng dụng ngân hàng hoặc ví VNPAY.
                                        </div>
                                    </label>
                                </div>

                                <div class="form-check p-3 border rounded bg-white shadow-sm position-relative">
                                    <input
                                        class="form-check-input position-absolute top-50 start-0 translate-middle-y ms-3"
                                        type="radio" name="paymentMethod" id="paymentMOMO" value="MOMO">
                                    <label class="form-check-label w-100 ps-5" for="paymentMOMO"
                                        style="cursor: pointer;">
                                        <div class="fw-bold fs-5 text-danger"><i class="fas fa-wallet me-2"></i>Thanh
                                            toán qua Ví MoMo</div>
                                        <div class="small text-muted">Chuyển tiền nhanh chóng qua ví điện tử MoMo.</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Auto-fill Script -->
                    <script th:if="${user != null}" th:inline="javascript">
                        /*<![CDATA[*/
                        var userProfile = {
                            fullName: /*[[${user.fullName}]]*/ '',
                            phone: /*[[${user.phone}]]*/ '',
                            address: /*[[${user.address}]]*/ ''
                        };

                        function fillAddress(isDefault) {
                            var nameInput = document.getElementById('receiverName');
                            var phoneInput = document.getElementById('phoneNumber');
                            var addressInput = document.getElementById('address');
                            var container = document.getElementById('shipping-info-fields');

                            if (isDefault) {
                                nameInput.value = userProfile.fullName || '';
                                phoneInput.value = userProfile.phone || '';
                                addressInput.value = userProfile.address || '';

                                // Visual effect: fade out manually entered fields or highlight
                                container.style.opacity = '0.7';
                            } else {
                                nameInput.value = '';
                                phoneInput.value = '';
                                addressInput.value = '';
                                container.style.opacity = '1';
                                nameInput.focus();
                            }
                        }
                        /*]]>*/
                    </script>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card-custom p-4">
                    <h3 class="mb-4 text-primary"><i class="fas fa-receipt me-2"></i>Đơn hàng</h3>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            th:each="item : ${cart.cartItems}">
                            <div>
                                <span class="fw-bold" th:text="${item.bookName}">Tên sách</span>
                                <br>
                                <small class="text-muted" th:text="'x' + ${item.quantity}"></small>
                            </div>
                            <span
                                th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'">Price</span>
                        </li>
                    </ul>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fs-5 fw-bold">Tổng cộng:</span>
                        <span class="fs-4 text-danger fw-bold"
                            th:text="${#numbers.formatDecimal(totalPrice, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'">Total</span>
                    </div>

                    <button type="submit" form="checkout-form" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">
                        ĐẶT HÀNG
                    </button>
                    <a href="/cart" class="btn btn-outline-secondary w-100 rounded-pill py-2 mt-2">Quay lại giỏ hàng</a>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{layout::footer}"></th:block>
</body>

</html>